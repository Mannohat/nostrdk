name: Auto-Create Resource PR from Issue

on:
  issues:
    types: [opened, reopened]

jobs:
  create-resource-pr:
    if: contains(github.event.issue.labels.*.name, 'ressource-forslag')
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Parse issue and create resource
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const issueBody = issue.body;
            
            const parseField = (fieldName) => {
              const regex = new RegExp('### ' + fieldName + '\\s+([\\s\\S]*?)(?=###|$)', 'i');
              const match = issueBody.match(regex);
              return match ? match[1].trim() : '';
            };
            
            const name = parseField('Ressource Navn / Resource Name');
            const url = parseField('URL');
            const categoryRaw = parseField('Kategori / Category');
            const section = parseField('Section Tag \\(valgfri / optional\\)') || '';
            const description = parseField('Beskrivelse / Description');
            
            const categoryMap = {
              'ðŸ”„ Nostr Alternativer (nostr-alternatives)': 'nostr-alternatives',
              'âš¡ Nostr Services (services)': 'services',
              'ðŸ”Œ Browser Udvidelser (extensions)': 'extensions',
              'ðŸ› ï¸ Nostr VÃ¦rktÃ¸jer (tools)': 'tools',
              'ðŸŒ Nostr Relays (relays)': 'relays'
            };
            
            const category = categoryMap[categoryRaw] || 'nostr-alternatives';
            
            const filename = name
              .toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/^-+|-+$/g, '') + '.md';
            
            const finalDescription = description.endsWith('.') ? description : description + '.';
            const finalUrl = url.endsWith('/') || url.includes('?') ? url : url + '/';
            
            let frontmatter = '---\n';
            frontmatter += 'title: "' + name + '"\n';
            frontmatter += 'description: "' + finalDescription + '"\n';
            frontmatter += 'url: "' + finalUrl + '"\n';
            frontmatter += 'category: "' + category + '"\n';
            if (section) {
              frontmatter += 'section: "' + section + '"\n';
            }
            frontmatter += 'order: 50\n';
            frontmatter += 'published: true\n';
            frontmatter += '---\n';
            
            core.exportVariable('RESOURCE_NAME', name);
            core.exportVariable('RESOURCE_FILENAME', filename);
            core.exportVariable('RESOURCE_CONTENT', frontmatter);
            core.exportVariable('RESOURCE_URL', finalUrl);
            core.exportVariable('RESOURCE_CATEGORY', category);
            core.exportVariable('RESOURCE_SECTION', section);
            core.exportVariable('RESOURCE_DESCRIPTION', finalDescription);
      
      - name: Create branch and file
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          BRANCH_NAME="add-resource-${RESOURCE_FILENAME%.md}"
          
          git checkout -b "$BRANCH_NAME"
          
          echo "$RESOURCE_CONTENT" > "src/content/resources/$RESOURCE_FILENAME"
          
          git add "src/content/resources/$RESOURCE_FILENAME"
          git commit -m "Add $RESOURCE_NAME from issue #${{ github.event.issue.number }}"
          git push origin "$BRANCH_NAME"
          
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const name = process.env.RESOURCE_NAME;
            const url = process.env.RESOURCE_URL;
            const category = process.env.RESOURCE_CATEGORY;
            const section = process.env.RESOURCE_SECTION;
            const description = process.env.RESOURCE_DESCRIPTION;
            const filename = process.env.RESOURCE_FILENAME;
            const branchName = process.env.BRANCH_NAME;
            
            const prBody = 'This PR adds **' + name + '** to the resources.\n\n' +
              '**Auto-generated from issue #' + context.issue.number + '**\n\n' +
              '## Resource Details\n' +
              '- **Name:** ' + name + '\n' +
              '- **URL:** ' + url + '\n' +
              '- **Category:** ' + category + '\n' +
              (section ? '- **Section:** ' + section + '\n' : '') +
              '- **Description:** ' + description + '\n\n' +
              '## Review Checklist\n' +
              '- [ ] URL is correct and works\n' +
              '- [ ] Description is accurate\n' +
              '- [ ] Category is appropriate\n' +
              '- [ ] Filename follows convention (' + filename + ')\n' +
              '- [ ] Order value is reasonable (currently set to 50)\n\n' +
              '---\n' +
              'Closes #' + context.issue.number;
            
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Add ' + name + ' to resources',
              head: branchName,
              base: 'main',
              body: prBody
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ðŸŽ‰ Thanks for the suggestion!\n\nI have automatically created a Pull Request with this resource: #' + pr.data.number + '\n\nThe maintainer will review and merge it soon!'
            });
