name: Auto-Create Resource PR from Issue

on:
  issues:
    types: [opened, reopened]

jobs:
  create-resource-pr:
    if: contains(github.event.issue.labels.*.name, 'ressource-forslag')
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Parse issue and create resource file
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const issueBody = issue.body;
            
            const parseField = (fieldName) => {
              const regex = new RegExp('### ' + fieldName + '\\s+([\\s\\S]*?)(?=###|$)', 'i');
              const match = issueBody.match(regex);
              return match ? match[1].trim() : '';
            };
            
            const name = parseField('Ressource Navn / Resource Name');
            const url = parseField('URL');
            const categoryRaw = parseField('Kategori / Category');
            const section = parseField('Section Tag \\(valgfri / optional\\)') || '';
            const description = parseField('Beskrivelse / Description');
            
            const categoryMap = {
              'üîÑ Nostr Alternativer (nostr-alternatives)': 'nostr-alternatives',
              '‚ö° Nostr Services (services)': 'services',
              'üîå Browser Udvidelser (extensions)': 'extensions',
              'üõ†Ô∏è Nostr V√¶rkt√∏jer (tools)': 'tools',
              'üåê Nostr Relays (relays)': 'relays'
            };
            
            const category = categoryMap[categoryRaw] || 'nostr-alternatives';
            
            const filename = name
              .toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/^-+|-+$/g, '') + '.md';
            
            const finalDescription = description.endsWith('.') ? description : description + '.';
            const finalUrl = url.endsWith('/') || url.includes('?') ? url : url + '/';
            
            let frontmatter = '---\n';
            frontmatter += 'title: "' + name + '"\n';
            frontmatter += 'description: "' + finalDescription + '"\n';
            frontmatter += 'url: "' + finalUrl + '"\n';
            frontmatter += 'category: "' + category + '"\n';
            if (section) {
              frontmatter += 'section: "' + section + '"\n';
            }
            frontmatter += 'order: 50\n';
            frontmatter += 'published: true\n';
            frontmatter += '---\n';
            
            const branchName = 'add-resource-' + filename.replace('.md', '');
            
            const repoInfo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const defaultBranch = repoInfo.data.default_branch;
            
            const branchInfo = await github.rest.repos.getBranch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: defaultBranch
            });
            
            const sha = branchInfo.data.commit.sha;
            
            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: 'refs/heads/' + branchName,
                sha: sha
              });
              console.log('Created branch: ' + branchName);
            } catch (error) {
              console.log('Branch may already exist:', error.message);
            }
            
            const filePath = 'src/content/resources/' + filename;
            
            try {
              await github.rest.repos.createOrUpdateFileContents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: filePath,
                message: 'Add ' + name + ' resource from issue #' + issue.number,
                content: Buffer.from(frontmatter).toString('base64'),
                branch: branchName
              });
              
              const prBody = 'This PR adds **' + name + '** to the resources.\n\n' +
                '**Auto-generated from issue #' + issue.number + '**\n\n' +
                '## Resource Details\n' +
                '- **Name:** ' + name + '\n' +
                '- **URL:** ' + finalUrl + '\n' +
                '- **Category:** ' + category + '\n' +
                (section ? '- **Section:** ' + section + '\n' : '') +
                '- **Description:** ' + finalDescription + '\n\n' +
                '## Review Checklist\n' +
                '- [ ] URL is correct and works\n' +
                '- [ ] Description is accurate\n' +
                '- [ ] Category is appropriate\n' +
                '- [ ] Filename follows convention (' + filename + ')\n' +
                '- [ ] Order value is reasonable (currently set to 50)\n\n' +
                '---\n' +
                'Closes #' + issue.number;
              
              const prResult = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Add ' + name + ' to resources',
                head: branchName,
                base: defaultBranch,
                body: prBody
              });
              
              const commentBody = 'üéâ Thanks for the suggestion!\n\n' +
                'I have automatically created a Pull Request with this resource: #' + prResult.data.number + '\n\n' +
                'The maintainer will review and merge it soon!';
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: commentBody
              });
              
              console.log('Created PR #' + prResult.data.number + ' for resource: ' + name);
              
            } catch (error) {
              console.error('Error creating file or PR:', error);
              
              const errorComment = '‚ö†Ô∏è There was an issue automatically creating the PR.\n\n' +
                'Error: ' + error.message + '\n\n' +
                'The maintainer will create this resource manually.';
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: errorComment
              });
              
              throw error;
            }
